<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 기본 앱 정보 -->
    <title>주은혜 찬양사역팀 매니저 Pro</title>
    <meta name="description" content="인천 온누리교회 주은혜 찬양사역팀 매니저 Pro">

    <!-- PWA 및 모바일 설정 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="주은혜매니저">
    <link rel="apple-touch-icon" href="https://jongsungjoo.github.io/grace/icon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#193278">
    <link rel="icon" type="image/png" sizes="192x192" href="https://jongsungjoo.github.io/grace/icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://jongsungjoo.github.io/grace/icon.png">
    <link rel="shortcut icon" href="https://jongsungjoo.github.io/grace/icon.png">

    <!-- SNS 공유용 -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="주은혜 찬양사역팀">
    <meta property="og:description" content="인천 온누리교회 주은혜 찬양사역팀 매니저 Pro">
    <meta property="og:image" content="https://jongsungjoo.github.io/grace/icon.png">

    <!-- 동적 매니페스트 생성 (아이콘 오류 방지) -->
    <script>
        (function() {
            const manifest = {
                "name": "주은혜 찬양사역팀 Pro",
                "short_name": "주은혜매니저",
                "start_url": "./index.html",
                "display": "standalone",
                "orientation": "portrait",
                "background_color": "#f8faff",
                "theme_color": "#193278",
                "icons": [
                    { "src": "https://jongsungjoo.github.io/grace/icon.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
                    { "src": "https://jongsungjoo.github.io/grace/icon.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
                ]
            };
            const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = URL.createObjectURL(blob);
            document.head.appendChild(link);
        })();
    </script>
    
    <!-- 필수 라이브러리 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --primary: #193278; --bg: #f8faff; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: #333; -webkit-tap-highlight-color: transparent; }
        .scroll-container { flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .error-shake { animation: shake 0.2s ease-in-out 2; }
    </style>
</head>
<body class="h-full overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDribbbOpi9VcnLu3szJZnT06R4dhx9eww",
            authDomain: "onnuri-grace.firebaseapp.com",
            projectId: "onnuri-grace",
            storageBucket: "onnuri-grace.firebasestorage.app",
            messagingSenderId: "349044849326",
            appId: "1:349044849326:web:8fa00da5f4a81eff318b3f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.MyFirebase = { auth, db, doc, collection, onSnapshot, setDoc, addDoc, deleteDoc, query, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
        window.FB_READY = true;
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const MASTER_PASSWORD = "onnurigrace";
        const SHARE_LINK = "https://cutt.ly/onnuri";
        const LOGO_URL = "https://jongsungjoo.github.io/grace/logo.png"; 
        const PARTS = [
            { id: 's', name: '소프라노', color: '#e91e63', bg: '#fdf2f8', border: '#fce7f3' },
            { id: 'a', name: '알토', color: '#ff9800', bg: '#fff7ed', border: '#ffedd5' },
            { id: 't', name: '테너', color: '#2196f3', bg: '#eff6ff', border: '#dbeafe' },
            { id: 'b', name: '베이스', color: '#37474f', bg: '#f8fafc', border: '#f1f5f9' }
        ];

        // Roster 파트 매핑용 (명단 관리/출석용)
        const ROSTER_PARTS = [
            { id: 'soprano', name: '소프라노', color: '#e91e63' },
            { id: 'alto', name: '알토', color: '#ff9800' },
            { id: 'tenor', name: '테너', color: '#2196f3' },
            { id: 'bass', name: '베이스', color: '#37474f' }
        ];

        function LucideIcon({ name, className = "w-5 h-5" }) {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    ref.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({ root: ref.current });
                }
            }, [name]);
            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} />;
        }

        function AppLogo({ className = "w-10 h-10" }) {
            return (
                <img 
                    src={LOGO_URL} 
                    className={`${className} object-contain rounded-full shadow-sm bg-white shrink-0`} 
                    onError={(e) => { e.target.src = 'https://via.placeholder.com/100?text=Grace'; }}
                />
            );
        }

        // --- Components ---

        function NavIconBtn({ id, icon, label, active, onClick }) {
            return (
                <button onClick={() => onClick(id)} className={`flex flex-col items-center gap-1 transition-all ${active ? 'text-[#193278] scale-105' : 'text-gray-300'}`}>
                    <LucideIcon name={icon} className="w-6 h-6" />
                    <span className="text-[10px] font-black uppercase">{label}</span>
                </button>
            );
        }

        function AuthModal({ onClose, onConfirm }) {
            const [input, setInput] = useState("");
            const [error, setError] = useState(false);
            const handleAttempt = () => {
                if (input === MASTER_PASSWORD) onConfirm();
                else {
                    setError(true);
                    setInput("");
                    setTimeout(() => setError(false), 2000);
                }
            };
            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[500] flex items-center justify-center p-5">
                    <div className="bg-white p-8 rounded-[32px] w-full max-w-sm scale-in text-center shadow-2xl">
                        <h3 className="text-xl font-black text-[#193278] mb-2">매니저 인증</h3>
                        <p className="text-sm text-gray-400 mb-6">비밀번호를 입력하세요.</p>
                        <input 
                            type="password" 
                            autoFocus 
                            className={`w-full bg-gray-50 border-2 p-4 rounded-2xl font-bold text-center outline-none transition-all ${error ? 'border-red-500 error-shake bg-red-50' : 'border-transparent focus:border-[#193278]'}`} 
                            placeholder="••••••••" 
                            value={input} 
                            onChange={e=>setInput(e.target.value)} 
                            onKeyDown={e=>e.key==='Enter' && handleAttempt()} 
                        />
                        <div className="flex gap-2 mt-8">
                            <button onClick={onClose} className="flex-1 py-4 font-bold text-gray-400">취소</button>
                            <button onClick={handleAttempt} className="flex-[2] py-4 bg-[#193278] text-white rounded-2xl font-black shadow-lg">확인</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Views ---

        function MusicView({ songs, requestAuth, isAdmin, showToast }) {
            const [searchTerm, setSearchTerm] = useState('');
            const filtered = songs.filter(s => (s.title || "").toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="space-y-6 fade-in">
                    <div className="flex justify-between items-center">
                        <div className="text-left">
                            <h2 className="text-3xl font-black text-gray-800">성가음원&악보</h2>
                            <p className="text-xs text-gray-400 font-bold">연습용 음원 및 악보 아카이브</p>
                        </div>
                    </div>

                    <div className="relative w-full">
                        <input 
                            type="text" 
                            placeholder="성가 제목 검색..." 
                            className="w-full bg-white border border-gray-100 p-4 pl-12 rounded-2xl font-bold shadow-sm outline-none focus:ring-2 focus:ring-blue-100" 
                            value={searchTerm} 
                            onChange={e => setSearchTerm(e.target.value)} 
                        />
                        <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-300">
                            <LucideIcon name="search" className="w-5 h-5" />
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {filtered.map(song => (
                            <div key={song.id} className="bg-white rounded-[24px] overflow-hidden shadow-sm border border-gray-100 flex h-32 sm:h-36 group hover:shadow-md transition-all">
                                {/* Thumbnail */}
                                <div className="w-28 sm:w-36 shrink-0 relative bg-gray-50 border-r border-gray-50">
                                    {song.image ? (
                                        <img src={song.image} className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-gray-200">
                                            <LucideIcon name="music" className="w-8 h-8" />
                                        </div>
                                    )}
                                    {isAdmin && (
                                        <div className="absolute top-2 left-2 flex gap-1">
                                            <button className="bg-white/90 p-1.5 rounded-full text-blue-500 shadow-sm"><LucideIcon name="edit-2" className="w-3 h-3" /></button>
                                        </div>
                                    )}
                                </div>

                                {/* Content */}
                                <div className="flex-1 p-3 sm:p-4 flex flex-col justify-between min-w-0">
                                    <div className="min-w-0">
                                        <h3 className="text-base sm:text-lg font-black text-gray-800 truncate mb-0.5">{song.title}</h3>
                                        <p className="text-[10px] sm:text-xs font-bold text-[#193278] opacity-60">{song.date}</p>
                                    </div>

                                    {/* Part Buttons - 개선된 적응형 레이아웃 */}
                                    <div className="flex flex-wrap gap-1.5 mt-2">
                                        {PARTS.map(p => {
                                            const hasLink = song.links?.[p.id];
                                            return (
                                                <button 
                                                    key={p.id} 
                                                    onClick={() => hasLink && window.open(hasLink, '_blank')}
                                                    className={`
                                                        px-2.5 py-1.5 sm:px-3 sm:py-2 rounded-xl text-[10px] sm:text-xs font-black transition-all border shrink-0
                                                        ${hasLink 
                                                            ? `shadow-sm hover:translate-y-[-1px] active:scale-95` 
                                                            : 'opacity-20 grayscale pointer-events-none'}
                                                    `}
                                                    style={{ 
                                                        color: hasLink ? p.color : '#ccc',
                                                        backgroundColor: hasLink ? p.bg : '#f5f5f5',
                                                        borderColor: hasLink ? p.border : '#eee'
                                                    }}
                                                >
                                                    {p.id.toUpperCase()}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- Main App ---

        function App() {
            const [ready, setReady] = useState(false);
            const [activeTab, setActiveTab] = useState('music'); 
            const [isAdmin, setIsAdmin] = useState(false);
            const [members, setMembers] = useState([]);
            const [history, setHistory] = useState([]);
            const [songs, setSongs] = useState([]);
            const [videos, setVideos] = useState([]);
            const [authModal, setAuthModal] = useState(false);
            const [toast, setToast] = useState({ show: false, msg: '' });

            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FB_READY) {
                        clearInterval(checkFB);
                        initData();
                    }
                }, 100);
            }, []);

            const initData = async () => {
                const { auth, db, doc, collection, onSnapshot, signInAnonymously } = window.MyFirebase;
                await signInAnonymously(auth);
                
                onSnapshot(doc(db, 'roster', 'current'), s => s.exists() && setMembers(s.data().list));
                onSnapshot(collection(db, 'history'), s => {
                    const list = []; s.forEach(d => list.push({ id: d.id, ...d.data() }));
                    setHistory(list.sort((a,b) => b.date.localeCompare(a.date)));
                });
                onSnapshot(collection(db, 'music'), s => {
                    const list = []; s.forEach(d => list.push({ id: d.id, ...d.data() }));
                    setSongs(list.sort((a,b) => (b.date||"").localeCompare(a.date||"")));
                });
                onSnapshot(collection(db, 'videos'), s => {
                    const list = []; s.forEach(d => list.push({ id: d.id, ...d.data() }));
                    setVideos(list.sort((a,b) => (b.date||"").localeCompare(a.date||"")));
                });
                setReady(true);
            };

            const showToast = (msg) => { setToast({ show: true, msg }); setTimeout(() => setToast({ show: false, msg: '' }), 3000); };
            const requestAuth = (callback) => { if (isAdmin) callback(); else setAuthModal(true); };
            const handleShare = () => { 
                const t = document.createElement("textarea"); t.value = SHARE_LINK; document.body.appendChild(t); t.select(); 
                document.execCommand('copy'); document.body.removeChild(t); showToast("공유 링크 복사 완료!"); 
            };

            if (!ready) return <div className="h-screen flex items-center justify-center bg-[#f8faff]"><div className="w-10 h-10 border-4 border-t-[#193278] rounded-full animate-spin"></div></div>;

            return (
                <div className="flex h-screen bg-[#f8faff] overflow-hidden w-full flex-col md:flex-row">
                    {/* Desktop Sidebar */}
                    <aside className="hidden md:flex flex-col w-64 bg-white border-r border-gray-100 p-6 shrink-0">
                        <div className="mb-10 flex items-center gap-3">
                            <AppLogo className="w-10 h-10" />
                            <div>
                                <h1 className="text-xl font-black text-[#193278]">주은혜 찬양사역팀</h1>
                                <div className="text-[10px] text-gray-300 font-bold uppercase">{isAdmin ? 'Admin' : 'Online'}</div>
                            </div>
                        </div>
                        <nav className="flex-1 space-y-2">
                            <button onClick={()=>setActiveTab('music')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab==='music' ? 'bg-blue-50 text-[#193278] font-bold shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}><LucideIcon name="music-2" /> 성가음원&악보</button>
                            <button onClick={()=>setActiveTab('videos')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab==='videos' ? 'bg-blue-50 text-[#193278] font-bold shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}><LucideIcon name="play-circle" /> 찬양팀영상</button>
                            <button onClick={()=>setActiveTab('stats')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab==='stats' ? 'bg-blue-50 text-[#193278] font-bold shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}><LucideIcon name="bar-chart-2" /> 출석현황판</button>
                            <div className="pt-6 pb-2 text-[10px] font-black text-gray-200 uppercase px-4">Manager</div>
                            <button onClick={()=>requestAuth(()=>setActiveTab('manage'))} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab==='manage' ? 'bg-blue-50 text-[#193278] font-bold shadow-sm' : 'text-gray-400 hover:bg-gray-50'}`}><LucideIcon name="user-round" /> 명단관리</button>
                        </nav>
                        <div className="mt-auto space-y-2">
                            <button onClick={handleShare} className="w-full flex items-center justify-center gap-2 py-3 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold transition-transform active:scale-95"><LucideIcon name="share-2" className="w-3.5 h-3.5" /> 링크 공유</button>
                        </div>
                    </aside>

                    {/* Main Section */}
                    <main className="flex-1 flex flex-col min-h-0 relative">
                        {/* Mobile Header */}
                        <header className="md:hidden bg-white px-5 h-16 flex items-center justify-between border-b border-gray-100 z-20">
                            <div className="flex items-center gap-2">
                                <AppLogo className="w-8 h-8" />
                                <span className="font-black text-lg text-[#193278]">주은혜 찬양사역팀</span>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={() => requestAuth(() => setActiveTab('manage'))} className="p-2 text-gray-400">
                                    <LucideIcon name="user-round" className="w-5 h-5" />
                                </button>
                                <button onClick={handleShare} className="p-2 text-blue-500">
                                    <LucideIcon name="share-2" className="w-5 h-5" />
                                </button>
                                {isAdmin && (
                                    <button onClick={() => window.location.reload()} className="p-2 text-red-500">
                                        <LucideIcon name="log-out" className="w-5 h-5" />
                                    </button>
                                )}
                            </div>
                        </header>

                        {/* Content Area */}
                        <div className="flex-1 scroll-container p-4 md:p-10 pb-32 md:pb-10 hide-scrollbar">
                            <div className="max-w-4xl mx-auto">
                                {activeTab === 'music' && <MusicView songs={songs} requestAuth={requestAuth} isAdmin={isAdmin} showToast={showToast} />}
                                {activeTab === 'videos' && <div className="text-center py-20 text-gray-300">영상 목록 로드 중...</div>}
                                {activeTab === 'stats' && <div className="text-center py-20 text-gray-300">출석부 로드 중...</div>}
                                {activeTab === 'manage' && <div className="text-center py-20 text-gray-300">관리 메뉴 준비 중...</div>}
                            </div>
                        </div>

                        {/* Mobile Bottom Nav (3 Buttons) */}
                        <nav className="md:hidden fixed bottom-0 left-0 right-0 h-20 bg-white border-t border-gray-100 flex items-center justify-around z-50">
                            <NavIconBtn id="music" icon="music-2" label="음원" active={activeTab === 'music'} onClick={setActiveTab} />
                            <NavIconBtn id="videos" icon="play-circle" label="영상" active={activeTab === 'videos'} onClick={setActiveTab} />
                            <NavIconBtn id="stats" icon="bar-chart-2" label="출석" active={activeTab === 'stats'} onClick={setActiveTab} />
                        </nav>
                    </main>

                    {/* Modals & Toasts */}
                    {authModal && <AuthModal onClose={() => setAuthModal(false)} onConfirm={() => { setIsAdmin(true); setAuthModal(false); showToast("관리자 모드 활성화"); }} />}
                    {toast.show && <div className="fixed bottom-24 md:bottom-10 left-1/2 -translate-x-1/2 bg-gray-900/90 text-white px-6 py-3 rounded-full text-sm font-bold z-[600] shadow-xl animate-bounce">{toast.msg}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
